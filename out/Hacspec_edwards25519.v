(* File automatically generated by Hacspec *)
From Hacspec Require Import Hacspec_Lib MachineIntegers.
From Coq Require Import ZArith.
Import List.ListNotations.
Open Scope Z_scope.
Open Scope bool_scope.

(*Not implemented yet? todo(item)*)

Require Import Hacspec_lib.

Require Import Hacspec_sha512.

Notation FieldCanvas := (nseq int8 256).
Notation Ed25519FieldElement_t := (nat_mod 0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed).
Definition Ed25519FieldElement : Ed25519FieldElement_t -> Ed25519FieldElement_t :=
  id.

Notation ScalarCanvas := (nseq int8 256).
Notation Scalar_t := (nat_mod 0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed).
Definition Scalar : Scalar_t -> Scalar_t :=
  id.

Notation BigScalarCanvas := (nseq int8 512).
Notation BigScalar_t := (nat_mod 0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed).
Definition BigScalar : BigScalar_t -> BigScalar_t :=
  id.

Notation BigIntegerCanvas := (nseq int8 256).
Notation BigInteger_t := (nat_mod 0x8000000000000000000000000000000080000000000000000000000000000000).
Definition BigInteger : BigInteger_t -> BigInteger_t :=
  id.

Notation t_EdPoint_t := ((t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)).

Notation CompressedEdPoint_t := (nseq int8 32).
Definition CompressedEdPoint : CompressedEdPoint_t -> CompressedEdPoint_t :=
  id.

Notation SerializedScalar_t := (nseq int8 32).
Definition SerializedScalar : SerializedScalar_t -> SerializedScalar_t :=
  id.

Notation Signature_t := (nseq int8 64).
Definition Signature : Signature_t -> Signature_t :=
  id.

Notation t_PublicKey_t := (t_CompressedEdPoint_t).

Notation t_SecretKey_t := (t_SerializedScalar_t).

Inductive t_Error : Type :=
| Error_InvalidPublickeyt_Error
| Error_InvalidSignaturet_Error
| Error_InvalidSt_Error
| Error_InvalidRt_Error
| Error_SmallOrderPointt_Error
| Error_NotEnoughRandomnesst_Error.

Notation t_VerifyResult_t := (t_Result_t (unit) (t_Error_t)).

Definition v_BASE : t_CompressedEdPoint_t :=
  CompressedEdPoint (array_from_list [U8 (@repr WORDSIZE8 88);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102);
    U8 (@repr WORDSIZE8 102)]).

Definition v_CONSTANT_P : t_SerializedScalar_t :=
  SerializedScalar (array_from_list [U8 (@repr WORDSIZE8 237);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 127)]).

Definition v_CONSTANT_L : t_SerializedScalar_t :=
  SerializedScalar (array_from_list [U8 (@repr WORDSIZE8 237);
    U8 (@repr WORDSIZE8 211);
    U8 (@repr WORDSIZE8 245);
    U8 (@repr WORDSIZE8 92);
    U8 (@repr WORDSIZE8 26);
    U8 (@repr WORDSIZE8 99);
    U8 (@repr WORDSIZE8 18);
    U8 (@repr WORDSIZE8 88);
    U8 (@repr WORDSIZE8 214);
    U8 (@repr WORDSIZE8 156);
    U8 (@repr WORDSIZE8 247);
    U8 (@repr WORDSIZE8 162);
    U8 (@repr WORDSIZE8 222);
    U8 (@repr WORDSIZE8 249);
    U8 (@repr WORDSIZE8 222);
    U8 (@repr WORDSIZE8 20);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 16)]).

Definition v_CONSTANT_P3_8_ : t_SerializedScalar_t :=
  SerializedScalar (array_from_list [U8 (@repr WORDSIZE8 254);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 15)]).

Definition v_CONSTANT_P1_4_ : t_SerializedScalar_t :=
  SerializedScalar (array_from_list [U8 (@repr WORDSIZE8 251);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 255);
    U8 (@repr WORDSIZE8 31)]).

Definition v_CONSTANT_D : t_SerializedScalar_t :=
  SerializedScalar (array_from_list [U8 (@repr WORDSIZE8 163);
    U8 (@repr WORDSIZE8 120);
    U8 (@repr WORDSIZE8 89);
    U8 (@repr WORDSIZE8 19);
    U8 (@repr WORDSIZE8 202);
    U8 (@repr WORDSIZE8 77);
    U8 (@repr WORDSIZE8 235);
    U8 (@repr WORDSIZE8 117);
    U8 (@repr WORDSIZE8 171);
    U8 (@repr WORDSIZE8 216);
    U8 (@repr WORDSIZE8 65);
    U8 (@repr WORDSIZE8 65);
    U8 (@repr WORDSIZE8 77);
    U8 (@repr WORDSIZE8 10);
    U8 (@repr WORDSIZE8 112);
    U8 (@repr WORDSIZE8 0);
    U8 (@repr WORDSIZE8 152);
    U8 (@repr WORDSIZE8 232);
    U8 (@repr WORDSIZE8 121);
    U8 (@repr WORDSIZE8 119);
    U8 (@repr WORDSIZE8 121);
    U8 (@repr WORDSIZE8 64);
    U8 (@repr WORDSIZE8 199);
    U8 (@repr WORDSIZE8 140);
    U8 (@repr WORDSIZE8 115);
    U8 (@repr WORDSIZE8 254);
    U8 (@repr WORDSIZE8 111);
    U8 (@repr WORDSIZE8 43);
    U8 (@repr WORDSIZE8 238);
    U8 (@repr WORDSIZE8 108);
    U8 (@repr WORDSIZE8 3);
    U8 (@repr WORDSIZE8 82)]).

Definition is_negative (x : t_Ed25519FieldElement_t) : t_U8_t :=
  if
    bit_under_impl_63 x (@repr WORDSIZE32 0)
  then
    U8 (@repr WORDSIZE8 1)
  else
    U8 (@repr WORDSIZE8 0).

Definition compress (p : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : t_CompressedEdPoint_t :=
  let '(x,y,z,_) := (p) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let z_inv := (inv_under_impl_57 z) : t_Ed25519FieldElement_t in
  let x := (x.*z_inv) : _ in
  let y := (y.*z_inv) : _ in
  let s := (to_byte_seq_le_under_impl y) : t_Seq_t t_U8_t in
  let s := (update_at s (@repr WORDSIZE32 31) ((s.[(@repr WORDSIZE32 31)]).^((is_negative x) shift_left (@repr WORDSIZE32 7)))) : t_Seq_t t_U8_t in
  from_slice_under_impl_274 s (@repr WORDSIZE32 0) (@repr WORDSIZE32 32).

Definition sqrt (a : t_Ed25519FieldElement_t) : t_Option_t t_Ed25519FieldElement_t :=
  let p3_8 := (from_byte_seq_le_under_impl v_CONSTANT_P3_8_) : t_Ed25519FieldElement_t in
  let p1_4 := (from_byte_seq_le_under_impl v_CONSTANT_P1_4_) : t_Ed25519FieldElement_t in
  let x_c := (pow_self a p3_8) : t_Ed25519FieldElement_t in
  let result := (Option_Nonet_Option_t t_Ed25519FieldElement_t) : t_Option_t t_Ed25519FieldElement_t in
  let result := (if
      (x_c.*x_c)=.?a
    then
      let result := (Option_Some x_c) : t_Option_t t_Ed25519FieldElement_t in
      result
    else
      result) : t_Option_t t_Ed25519FieldElement_t in
  let result := (if
      (x_c.*x_c)=.?(v_ZERO.-a)
    then
      let x := ((pow_self v_TWO p1_4).*x_c) : _ in
      let result := (Option_Some x) : t_Option_t t_Ed25519FieldElement_t in
      result
    else
      result) : t_Option_t t_Ed25519FieldElement_t in
  result.

Definition check_canonical_point (x : t_CompressedEdPoint_t) : bool :=
  let x := (update_at x (@repr WORDSIZE32 31) ((x.[(@repr WORDSIZE32 31)]).&(U8 (@repr WORDSIZE8 127)))) : t_CompressedEdPoint_t in
  let x := (from_byte_seq_le_under_impl_201 x) : t_BigInteger_t in
  x<.?(from_byte_seq_le_under_impl_201 v_CONSTANT_P).

Definition decompress (q : t_CompressedEdPoint_t) : t_Option_t (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) :=
  run (let d := (from_byte_seq_le_under_impl v_CONSTANT_D) : t_Ed25519FieldElement_t in
  let x_s := (((q.[(@repr WORDSIZE32 31)]).&(U8 (@repr WORDSIZE8 128))) shift_right (@repr WORDSIZE32 7)) : _ in
  let y_s := (q) : t_CompressedEdPoint_t in
  let y_s := (update_at y_s (@repr WORDSIZE32 31) ((y_s.[(@repr WORDSIZE32 31)]).&(U8 (@repr WORDSIZE8 127)))) : t_CompressedEdPoint_t in
  let _ := (if
      not (check_canonical_point y_s)
    then
      let _ := (Option_Nonet_Option_t (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
      Option_Some tt
    else
      Option_Some tt) : unit in
  let y := (from_byte_seq_le_under_impl y_s) : t_Ed25519FieldElement_t in
  let z := (v_ONE) : t_Ed25519FieldElement_t in
  let yy := (y.*y) : _ in
  let u := (yy.-z) : _ in
  let v := ((d.*yy).+z) : _ in
  let xx := (u.*(inv_under_impl_57 v)) : _ in
  let x := (from_residual (sqrt xx)) : t_Option_t (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let x_r := (is_negative x) : t_U8_t in
  let _ := (if
      andb (x=.?v_ZERO) ((declassify_under_impl_2 x_s)=.?(@repr WORDSIZE8 1))
    then
      let _ := (Option_Nonet_Option_t (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
      Option_Some tt
    else
      Option_Some tt) : unit in
  Option_Some (let x := (if
      (declassify_under_impl_2 x_r)<>(declassify_under_impl_2 x_s)
    then
      let x := (v_ZERO.-x) : _ in
      x
    else
      x) : _ in
  Option_Some (x,y,z,x.*y))).

Definition decompress_non_canonical (p : t_CompressedEdPoint_t) : t_Option_t (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) :=
  let d := (from_byte_seq_le_under_impl v_CONSTANT_D) : t_Ed25519FieldElement_t in
  let x_s := (((p.[(@repr WORDSIZE32 31)]).&(U8 (@repr WORDSIZE8 128))) shift_right (@repr WORDSIZE32 7)) : _ in
  let y_s := (p) : t_CompressedEdPoint_t in
  let y_s := (update_at y_s (@repr WORDSIZE32 31) ((y_s.[(@repr WORDSIZE32 31)]).&(U8 (@repr WORDSIZE8 127)))) : t_CompressedEdPoint_t in
  let y := (from_byte_seq_le_under_impl y_s) : t_Ed25519FieldElement_t in
  let z := (v_ONE) : t_Ed25519FieldElement_t in
  let yy := (y.*y) : _ in
  let u := (yy.-z) : _ in
  let v := ((d.*yy).+z) : _ in
  let xx := (u.*(inv_under_impl_57 v)) : _ in
  let x := (from_residual (sqrt xx)) : t_Option_t (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let x_r := (is_negative x) : t_U8_t in
  let x := (if
      (declassify_under_impl_2 x_r)<>(declassify_under_impl_2 x_s)
    then
      let x := (v_ZERO.-x) : _ in
      x
    else
      x) : _ in
  Option_Some (x,y,z,x.*y).

Definition encode (p : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : t_Seq_t t_U8_t :=
  let '(x,y,z,_) := (p) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let z_inv := (inv_under_impl_57 z) : t_Ed25519FieldElement_t in
  let x := (x.*z_inv) : _ in
  let y := (y.*z_inv) : _ in
  let s := (to_byte_seq_le_under_impl y) : t_Seq_t t_U8_t in
  let s := (update_at s (@repr WORDSIZE32 31) ((s.[(@repr WORDSIZE32 31)]).^((is_negative x) shift_left (@repr WORDSIZE32 7)))) : t_Seq_t t_U8_t in
  s.

Definition decode (q_s : t_Seq_t t_U8_t) : t_Option_t (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) :=
  let q := (from_slice_under_impl_274 q_s (@repr WORDSIZE32 0) (@repr WORDSIZE32 32)) : t_CompressedEdPoint_t in
  decompress q.

Definition point_add (p : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) (q : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) :=
  let d_c := (from_byte_seq_le_under_impl v_CONSTANT_D) : t_Ed25519FieldElement_t in
  let two := (v_TWO) : t_Ed25519FieldElement_t in
  let '(x1,y1,z1,t1) := (p) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let '(x2,y2,z2,t2) := (q) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let a := ((y1.-x1).*(y2.-x2)) : _ in
  let b := ((y1.+x1).*(y2.+x2)) : _ in
  let c := (((t1.*two).*d_c).*t2) : _ in
  let d := ((z1.*two).*z2) : _ in
  let e := (b.-a) : _ in
  let f := (d.-c) : _ in
  let g := (d.+c) : _ in
  let h := (b.+a) : _ in
  let x3 := (e.*f) : _ in
  let y3 := (g.*h) : _ in
  let t3 := (e.*h) : _ in
  let z3 := (f.*g) : _ in
  (x3,y3,z3,t3).

Definition point_identity : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) :=
  (v_ZERO,v_ONE,v_ONE,v_ZERO).

Definition point_mul (s : t_Scalar_t) (p : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) :=
  let p := (p) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let q := (point_identity) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let '(p,q) := (fold (into_iter (Build_Range (@repr WORDSIZE32 0)(@repr WORDSIZE32 256))) (p,q) (fun '(p,q) i =>
      let q := (if
          bit_under_impl_130 s i
        then
          let q := (point_add q p) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
          q
        else
          q) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
      let p := (point_add p p) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
      (p,q))) : ((t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) × (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) in
  q.

Definition point_mul_by_cofactor (p : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) :=
  let p2 := (point_add p p) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let p4 := (point_add p2 p2) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  point_add p4 p4.

Definition point_neg (p : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) :=
  let '(x,y,z,t) := (p) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  (v_ZERO.-x,y,z,v_ZERO.-t).

Definition point_eq (p : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) (q : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : bool :=
  let '(x1,y1,z1,_) := (p) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let '(x2,y2,z2,_) := (q) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  andb ((x1.*z2)=.?(x2.*z1)) ((y1.*z2)=.?(y2.*z1)).

Definition point_normalize (q : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t)) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) :=
  let '(qx,qy,qz,_) := (q) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let px := (qx.*(inv_under_impl_57 qz)) : _ in
  let py := (qy.*(inv_under_impl_57 qz)) : _ in
  let pz := (v_ONE) : t_Ed25519FieldElement_t in
  let pt := (px.*py) : _ in
  (px,py,pz,pt).

Definition secret_expand (sk : t_SerializedScalar_t) : (t_SerializedScalar_t × t_SerializedScalar_t) :=
  let h := (sha512 (from_slice_under_impl_41 sk (@repr WORDSIZE32 0) (@repr WORDSIZE32 32))) : t_Sha512Digest_t in
  let h_d := (from_slice_under_impl_309 h (@repr WORDSIZE32 32) (@repr WORDSIZE32 32)) : t_SerializedScalar_t in
  let s := (from_slice_under_impl_309 h (@repr WORDSIZE32 0) (@repr WORDSIZE32 32)) : t_SerializedScalar_t in
  let s := (update_at s (@repr WORDSIZE32 0) ((s.[(@repr WORDSIZE32 0)]).&(U8 (@repr WORDSIZE8 248)))) : t_SerializedScalar_t in
  let s := (update_at s (@repr WORDSIZE32 31) ((s.[(@repr WORDSIZE32 31)]).&(U8 (@repr WORDSIZE8 127)))) : t_SerializedScalar_t in
  let s := (update_at s (@repr WORDSIZE32 31) ((s.[(@repr WORDSIZE32 31)]).|(U8 (@repr WORDSIZE8 64)))) : t_SerializedScalar_t in
  (s,h_d).

Definition secret_to_public (sk : t_SerializedScalar_t) : t_CompressedEdPoint_t :=
  let '(s,_) := (secret_expand sk) : (t_SerializedScalar_t × t_SerializedScalar_t) in
  let base := (unwrap_under_impl (decompress v_BASE)) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  let ss := (from_byte_seq_le_under_impl_67 s) : t_Scalar_t in
  let a := (point_mul ss base) : (t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t × t_Ed25519FieldElement_t) in
  compress a.

Definition check_canonical_scalar (s : t_SerializedScalar_t) : bool :=
  if
    (declassify_under_impl_2 ((s.[(@repr WORDSIZE32 31)]).&(U8 (@repr WORDSIZE8 224))))<>(@repr WORDSIZE8 0)
  then
    false
  else
    (from_byte_seq_le_under_impl_201 s)<.?(from_byte_seq_le_under_impl_201 v_CONSTANT_L).
