(* File automatically generated by Hacspec *)
From Hacspec Require Import Hacspec_Lib MachineIntegers.
From Coq Require Import ZArith.
Import List.ListNotations.
Open Scope Z_scope.
Open Scope bool_scope.

(*Not implemented yet? todo(item)*)

Require Import Hacspec_hmac.

Require Import Hacspec_lib.

Require Import Hacspec_sha256.

Definition v_HASH_LEN : uint_size :=
  (@repr WORDSIZE32 256)./(@repr WORDSIZE32 8).

Inductive t_HkdfError : Type :=
| HkdfError_InvalidOutputLengtht_HkdfError.

Notation t_HkdfByteSeqResult_t := (t_Result_t (t_Seq_t t_U8_t) (t_HkdfError_t)).

Definition extract (salt : t_Seq_t t_U8_t) (ikm : t_Seq_t t_U8_t) : t_PRK_t :=
  let salt_or_zero := (new_under_impl_41 v_HASH_LEN) : t_Seq_t t_U8_t in
  let salt_or_zero := (if
      (len_under_impl_41 salt)>.?(@repr WORDSIZE32 0)
    then
      from_seq_under_impl_52 salt
    else
      salt_or_zero) : t_Seq_t t_U8_t in
  from_seq_under_impl_18 (hmac salt_or_zero ikm).

Definition build_hmac_txt (t : t_Seq_t t_U8_t) (info : t_Seq_t t_U8_t) (iteration : t_U8_t) : t_Seq_t t_U8_t :=
  let out := (new_under_impl_41 (((len_under_impl_41 t).+(len_under_impl_41 info)).+(@repr WORDSIZE32 1))) : t_Seq_t t_U8_t in
  let out := (update out (@repr WORDSIZE32 0) t) : t_Seq_t t_U8_t in
  let out := (update out (len_under_impl_41 t) info) : t_Seq_t t_U8_t in
  let out := (update_at out ((len_under_impl_41 t).+(len_under_impl_41 info)) iteration) : t_Seq_t t_U8_t in
  out.

Definition div_ceil (a : uint_size) (b : uint_size) : uint_size :=
  let q := (a./b) : uint_size in
  let q := (if
      (a.%b)<>(@repr WORDSIZE32 0)
    then
      let q := (q.+(@repr WORDSIZE32 1)) : uint_size in
      q
    else
      q) : uint_size in
  q.

Definition check_output_limit (l : uint_size) : t_Result_t (uint_size) (t_HkdfError_t) :=
  let n := (div_ceil l v_HASH_LEN) : uint_size in
  if
    n<=.?(@repr WORDSIZE32 255)
  then
    Result_Ok n
  else
    Result_Err HkdfError_InvalidOutputLengtht_HkdfError_t.

Definition expand (prk : t_Seq_t t_U8_t) (info : t_Seq_t t_U8_t) (l : uint_size) : t_Result_t (t_Seq_t t_U8_t) (t_HkdfError_t) :=
  let n := (from_residual (check_output_limit l)) : t_Result_t (t_Seq_t t_U8_t) (t_HkdfError_t) in
  let t_i := (new_under_impl_5) : t_PRK_t in
  let t := (new_under_impl_41 (n.*v_HASH_SIZE)) : t_Seq_t t_U8_t in
  let '(t,t_i) := (fold (into_iter (Build_Range (@repr WORDSIZE32 0)n)) (t,t_i) (fun '(t,t_i) i =>
      let hmac_txt_in := (if
          i=.?(@repr WORDSIZE32 0)
        then
          build_hmac_txt (new_under_impl_41 (@repr WORDSIZE32 0)) info (U8 ((cast i).+(@repr WORDSIZE8 1)))
        else
          build_hmac_txt (from_seq_under_impl_52 t_i) info (U8 ((cast i).+(@repr WORDSIZE8 1)))) : t_Seq_t t_U8_t in
      let t_i := (hmac prk hmac_txt_in) : t_PRK_t in
      let t := (update t (i.*(len t_i)) t_i) : t_Seq_t t_U8_t in
      (t,t_i))) : (t_Seq_t t_U8_t Ã— t_PRK_t) in
  v_Ok (slice_under_impl_41 t (@repr WORDSIZE32 0) l).
