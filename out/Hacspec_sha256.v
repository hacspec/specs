(* File automatically generated by Hacspec *)
From Hacspec Require Import Hacspec_Lib MachineIntegers.
From Coq Require Import ZArith.
Import List.ListNotations.
Open Scope Z_scope.
Open Scope bool_scope.

(*Not implemented yet? todo(item)*)

Require Import Hacspec_lib.

Definition v_BLOCK_SIZE : uint_size :=
  (@repr WORDSIZE32 64).

Definition v_LEN_SIZE : uint_size :=
  (@repr WORDSIZE32 8).

Definition v_K_SIZE : uint_size :=
  (@repr WORDSIZE32 64).

Definition v_HASH_SIZE : uint_size :=
  (@repr WORDSIZE32 256)./(@repr WORDSIZE32 8).

Notation Block_t := (nseq int8 BLOCK_SIZE).
Definition Block : Block_t -> Block_t :=
  id.

Notation OpTableType_t := (nseq int32 12).
Definition OpTableType : OpTableType_t -> OpTableType_t :=
  id.

Notation Sha256Digest_t := (nseq int8 HASH_SIZE).
Definition Sha256Digest : Sha256Digest_t -> Sha256Digest_t :=
  id.

Notation RoundConstantsTable_t := (nseq int32 K_SIZE).
Definition RoundConstantsTable : RoundConstantsTable_t -> RoundConstantsTable_t :=
  id.

Notation Hash_t := (nseq int32 8).
Definition Hash : Hash_t -> Hash_t :=
  id.

Definition ch (x : t_U32_t) (y : t_U32_t) (z : t_U32_t) : _ :=
  (x.&y).^((not x).&z).

Definition maj (x : t_U32_t) (y : t_U32_t) (z : t_U32_t) : _ :=
  (x.&y).^((x.&z).^(y.&z)).

Definition v_OP_TABLE : t_OpTableType_t :=
  OpTableType (array_from_list [(@repr WORDSIZE32 2);
    (@repr WORDSIZE32 13);
    (@repr WORDSIZE32 22);
    (@repr WORDSIZE32 6);
    (@repr WORDSIZE32 11);
    (@repr WORDSIZE32 25);
    (@repr WORDSIZE32 7);
    (@repr WORDSIZE32 18);
    (@repr WORDSIZE32 3);
    (@repr WORDSIZE32 17);
    (@repr WORDSIZE32 19);
    (@repr WORDSIZE32 10)]).

Definition v_K_TABLE : t_RoundConstantsTable_t :=
  RoundConstantsTable (array_from_list [U32 (@repr WORDSIZE32 1116352408);
    U32 (@repr WORDSIZE32 1899447441);
    U32 (@repr WORDSIZE32 3049323471);
    U32 (@repr WORDSIZE32 3921009573);
    U32 (@repr WORDSIZE32 961987163);
    U32 (@repr WORDSIZE32 1508970993);
    U32 (@repr WORDSIZE32 2453635748);
    U32 (@repr WORDSIZE32 2870763221);
    U32 (@repr WORDSIZE32 3624381080);
    U32 (@repr WORDSIZE32 310598401);
    U32 (@repr WORDSIZE32 607225278);
    U32 (@repr WORDSIZE32 1426881987);
    U32 (@repr WORDSIZE32 1925078388);
    U32 (@repr WORDSIZE32 2162078206);
    U32 (@repr WORDSIZE32 2614888103);
    U32 (@repr WORDSIZE32 3248222580);
    U32 (@repr WORDSIZE32 3835390401);
    U32 (@repr WORDSIZE32 4022224774);
    U32 (@repr WORDSIZE32 264347078);
    U32 (@repr WORDSIZE32 604807628);
    U32 (@repr WORDSIZE32 770255983);
    U32 (@repr WORDSIZE32 1249150122);
    U32 (@repr WORDSIZE32 1555081692);
    U32 (@repr WORDSIZE32 1996064986);
    U32 (@repr WORDSIZE32 2554220882);
    U32 (@repr WORDSIZE32 2821834349);
    U32 (@repr WORDSIZE32 2952996808);
    U32 (@repr WORDSIZE32 3210313671);
    U32 (@repr WORDSIZE32 3336571891);
    U32 (@repr WORDSIZE32 3584528711);
    U32 (@repr WORDSIZE32 113926993);
    U32 (@repr WORDSIZE32 338241895);
    U32 (@repr WORDSIZE32 666307205);
    U32 (@repr WORDSIZE32 773529912);
    U32 (@repr WORDSIZE32 1294757372);
    U32 (@repr WORDSIZE32 1396182291);
    U32 (@repr WORDSIZE32 1695183700);
    U32 (@repr WORDSIZE32 1986661051);
    U32 (@repr WORDSIZE32 2177026350);
    U32 (@repr WORDSIZE32 2456956037);
    U32 (@repr WORDSIZE32 2730485921);
    U32 (@repr WORDSIZE32 2820302411);
    U32 (@repr WORDSIZE32 3259730800);
    U32 (@repr WORDSIZE32 3345764771);
    U32 (@repr WORDSIZE32 3516065817);
    U32 (@repr WORDSIZE32 3600352804);
    U32 (@repr WORDSIZE32 4094571909);
    U32 (@repr WORDSIZE32 275423344);
    U32 (@repr WORDSIZE32 430227734);
    U32 (@repr WORDSIZE32 506948616);
    U32 (@repr WORDSIZE32 659060556);
    U32 (@repr WORDSIZE32 883997877);
    U32 (@repr WORDSIZE32 958139571);
    U32 (@repr WORDSIZE32 1322822218);
    U32 (@repr WORDSIZE32 1537002063);
    U32 (@repr WORDSIZE32 1747873779);
    U32 (@repr WORDSIZE32 1955562222);
    U32 (@repr WORDSIZE32 2024104815);
    U32 (@repr WORDSIZE32 2227730452);
    U32 (@repr WORDSIZE32 2361852424);
    U32 (@repr WORDSIZE32 2428436474);
    U32 (@repr WORDSIZE32 2756734187);
    U32 (@repr WORDSIZE32 3204031479);
    U32 (@repr WORDSIZE32 3329325298)]).

Definition v_HASH_INIT : t_Hash_t :=
  Hash (array_from_list [U32 (@repr WORDSIZE32 1779033703);
    U32 (@repr WORDSIZE32 3144134277);
    U32 (@repr WORDSIZE32 1013904242);
    U32 (@repr WORDSIZE32 2773480762);
    U32 (@repr WORDSIZE32 1359893119);
    U32 (@repr WORDSIZE32 2600822924);
    U32 (@repr WORDSIZE32 528734635);
    U32 (@repr WORDSIZE32 1541459225)]).

Definition sigma (x : t_U32_t) (i : uint_size) (op : uint_size) : _ :=
  let tmp := (rotate_right_under_impl_66 x (v_OP_TABLE.[(((@repr WORDSIZE32 3).*i).+(@repr WORDSIZE32 2))])) : t_U32_t in
  let tmp := (if
      op=.?(@repr WORDSIZE32 0)
    then
      x shift_right (v_OP_TABLE.[(((@repr WORDSIZE32 3).*i).+(@repr WORDSIZE32 2))])
    else
      tmp) : _ in
  ((rotate_right_under_impl_66 x (v_OP_TABLE.[((@repr WORDSIZE32 3).*i)])).^(rotate_right_under_impl_66 x (v_OP_TABLE.[(((@repr WORDSIZE32 3).*i).+(@repr WORDSIZE32 1))]))).^tmp.

Definition schedule (block : t_Block_t) : t_RoundConstantsTable_t :=
  let b := (to_be_U32s_under_impl block) : t_Seq_t t_U32_t in
  let s := (new_under_impl_94) : t_RoundConstantsTable_t in
  let s := (fold (into_iter (Build_Range (@repr WORDSIZE32 0)v_K_SIZE)) s (fun s i =>
      if
        i<.?(@repr WORDSIZE32 16)
      then
        let s := (update_at s i (b.[i])) : t_RoundConstantsTable_t in
        s
      else
        let t16 := (s.[(i.-(@repr WORDSIZE32 16))]) : t_U32_t in
        let t15 := (s.[(i.-(@repr WORDSIZE32 15))]) : t_U32_t in
        let t7 := (s.[(i.-(@repr WORDSIZE32 7))]) : t_U32_t in
        let t2 := (s.[(i.-(@repr WORDSIZE32 2))]) : t_U32_t in
        let s1 := (sigma t2 (@repr WORDSIZE32 3) (@repr WORDSIZE32 0)) : t_U32_t in
        let s0 := (sigma t15 (@repr WORDSIZE32 2) (@repr WORDSIZE32 0)) : t_U32_t in
        let s := (update_at s i (((s1.+t7).+s0).+t16)) : t_RoundConstantsTable_t in
        s)) : t_RoundConstantsTable_t in
  s.

Definition shuffle (ws : t_RoundConstantsTable_t) (hashi : t_Hash_t) : t_Hash_t :=
  let h := (hashi) : t_Hash_t in
  let h := (fold (into_iter (Build_Range (@repr WORDSIZE32 0)v_K_SIZE)) h (fun h i =>
      let a0 := (h.[(@repr WORDSIZE32 0)]) : t_U32_t in
      let b0 := (h.[(@repr WORDSIZE32 1)]) : t_U32_t in
      let c0 := (h.[(@repr WORDSIZE32 2)]) : t_U32_t in
      let d0 := (h.[(@repr WORDSIZE32 3)]) : t_U32_t in
      let e0 := (h.[(@repr WORDSIZE32 4)]) : t_U32_t in
      let f0 := (h.[(@repr WORDSIZE32 5)]) : t_U32_t in
      let g0 := (h.[(@repr WORDSIZE32 6)]) : t_U32_t in
      let h0 := (h.[(@repr WORDSIZE32 7)]) : t_U32_t in
      let t1 := ((((h0.+(sigma e0 (@repr WORDSIZE32 1) (@repr WORDSIZE32 1))).+(ch e0 f0 g0)).+(v_K_TABLE.[i])).+(ws.[i])) : _ in
      let t2 := ((sigma a0 (@repr WORDSIZE32 0) (@repr WORDSIZE32 1)).+(maj a0 b0 c0)) : _ in
      let h := (update_at h (@repr WORDSIZE32 0) (t1.+t2)) : t_Hash_t in
      let h := (update_at h (@repr WORDSIZE32 1) a0) : t_Hash_t in
      let h := (update_at h (@repr WORDSIZE32 2) b0) : t_Hash_t in
      let h := (update_at h (@repr WORDSIZE32 3) c0) : t_Hash_t in
      let h := (update_at h (@repr WORDSIZE32 4) (d0.+t1)) : t_Hash_t in
      let h := (update_at h (@repr WORDSIZE32 5) e0) : t_Hash_t in
      let h := (update_at h (@repr WORDSIZE32 6) f0) : t_Hash_t in
      let h := (update_at h (@repr WORDSIZE32 7) g0) : t_Hash_t in
      h)) : t_Hash_t in
  h.

Definition compress (block : t_Block_t) (h_in : t_Hash_t) : t_Hash_t :=
  let s := (schedule block) : t_RoundConstantsTable_t in
  let h := (shuffle s h_in) : t_Hash_t in
  let h := (fold (into_iter (Build_Range (@repr WORDSIZE32 0)(@repr WORDSIZE32 8))) h (fun h i =>
      update_at h i ((h.[i]).+(h_in.[i])))) : t_Hash_t in
  h.

Definition hash (msg : t_Seq_t t_U8_t) : t_Sha256Digest_t :=
  let h := (v_HASH_INIT) : t_Hash_t in
  let last_block := (new_under_impl_5) : t_Block_t in
  let last_block_len := ((@repr WORDSIZE32 0)) : uint_size in
  let '(h,last_block,last_block_len) := (fold (into_iter (Build_Range (@repr WORDSIZE32 0)(num_chunks_under_impl_41 msg v_BLOCK_SIZE))) (h,last_block,last_block_len) (fun '(h,last_block,last_block_len) i =>
      let '(block_len,block) := (get_chunk_under_impl_41 msg v_BLOCK_SIZE i) : (uint_size × t_Seq_t t_U8_t) in
      if
        block_len<.?v_BLOCK_SIZE
      then
        let last_block := (update_start new_under_impl_5 block) : t_Block_t in
        let last_block_len := (block_len) : uint_size in
        (h,last_block,last_block_len)
      else
        let compress_input := (from_seq_under_impl_18 block) : t_Block_t in
        let h := (compress compress_input h) : t_Hash_t in
        (h,last_block,last_block_len))) : (t_Hash_t × t_Block_t × uint_size) in
  let last_block := (update_at last_block last_block_len (U8 (@repr WORDSIZE8 128))) : t_Block_t in
  let len_bist := (U64 (cast ((len_under_impl_41 msg).*(@repr WORDSIZE32 8)))) : t_U64_t in
  let '(h,last_block) := (if
      last_block_len<.?(v_BLOCK_SIZE.-v_LEN_SIZE)
    then
      let last_block := (update last_block (v_BLOCK_SIZE.-v_LEN_SIZE) (v_U64_to_be_bytes len_bist)) : t_Block_t in
      let h := (compress last_block h) : t_Hash_t in
      (h,last_block)
    else
      let pad_block := (new_under_impl_5) : t_Block_t in
      let pad_block := (update pad_block (v_BLOCK_SIZE.-v_LEN_SIZE) (v_U64_to_be_bytes len_bist)) : t_Block_t in
      let h := (compress last_block h) : t_Hash_t in
      let h := (compress pad_block h) : t_Hash_t in
      (h,last_block)) : (t_Hash_t × t_Block_t) in
  from_seq_under_impl_73 (to_be_bytes_under_impl_126 h).

Definition sha256 (msg : t_Seq_t t_U8_t) : t_Sha256Digest_t :=
  hash msg.
