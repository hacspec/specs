(* File automatically generated by Hacspec *)
From Hacspec Require Import Hacspec_Lib MachineIntegers.
From Coq Require Import ZArith.
Import List.ListNotations.
Open Scope Z_scope.
Open Scope bool_scope.

(*Not implemented yet? todo(item)*)

Require Import Hacspec_lib.

Notation PolyKey_t := (nseq int8 32).
Definition PolyKey : PolyKey_t -> PolyKey_t :=
  id.

Definition v_BLOCKSIZE : uint_size :=
  (@repr WORDSIZE32 16).

Notation PolyBlock_t := (nseq int8 16).
Definition PolyBlock : PolyBlock_t -> PolyBlock_t :=
  id.

Notation Poly1305Tag_t := (nseq int8 16).
Definition Poly1305Tag : Poly1305Tag_t -> Poly1305Tag_t :=
  id.

Notation t_SubBlock_t := (t_Seq_t t_U8_t).

Notation t_BlockIndex_t := (uint_size).

Notation FieldCanvas := (nseq int8 131).
Notation FieldElement_t := (nat_mod 0x03fffffffffffffffffffffffffffffffb).
Definition FieldElement : FieldElement_t -> FieldElement_t :=
  id.

Notation t_PolyState_t := ((t_FieldElement_t × t_FieldElement_t × t_PolyKey_t)).

Definition poly1305_encode_r (b : t_PolyBlock_t) : t_FieldElement_t :=
  let n := (v_U128_from_le_bytes (from_seq_under_impl_123 b)) : t_U128_t in
  let n := (n.&(U128 (@repr WORDSIZE128 21267647620597763993911028882763415551))) : _ in
  from_secret_literal_under_impl_105 n.

Definition poly1305_encode_block (b : t_PolyBlock_t) : _ :=
  let n := (v_U128_from_le_bytes (from_seq_under_impl_123 b)) : t_U128_t in
  let f := (from_secret_literal_under_impl_105 n) : t_FieldElement_t in
  f.+(pow2_under_impl_162 (@repr WORDSIZE32 128)).

Definition poly1305_encode_last (pad_len : uint_size) (b : t_Seq_t t_U8_t) : _ :=
  let n := (v_U128_from_le_bytes (from_slice_under_impl_111 b (@repr WORDSIZE32 0) (len_under_impl_41 b))) : t_U128_t in
  let f := (from_secret_literal_under_impl_105 n) : t_FieldElement_t in
  f.+(pow2_under_impl_162 ((@repr WORDSIZE32 8).*pad_len)).

Definition poly1305_init (k : t_PolyKey_t) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) :=
  let r := (poly1305_encode_r (from_slice_under_impl_41 k (@repr WORDSIZE32 0) (@repr WORDSIZE32 16))) : t_FieldElement_t in
  (v_ZERO,r,k).

Definition poly1305_update_block (b : t_PolyBlock_t) (st : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t)) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) :=
  let '(acc,r,k) := (st) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
  (((poly1305_encode_block b).+acc).*r,r,k).

Definition poly1305_update_blocks (m : t_Seq_t t_U8_t) (st : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t)) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) :=
  let st := (st) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
  let n_blocks := ((len_under_impl_41 m)./v_BLOCKSIZE) : uint_size in
  let st := (fold (into_iter (Build_Range (@repr WORDSIZE32 0)n_blocks)) st (fun st i =>
      let block := (from_seq_under_impl_53 (get_exact_chunk_under_impl_41 m v_BLOCKSIZE i)) : t_PolyBlock_t in
      let st := (poly1305_update_block block st) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
      st)) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
  st.

Definition poly1305_update_last (pad_len : uint_size) (b : t_Seq_t t_U8_t) (st : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t)) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) :=
  let st := (st) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
  let st := (if
      (len_under_impl_41 b)<>(@repr WORDSIZE32 0)
    then
      let '(acc,r,k) := (st) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
      let st := ((((poly1305_encode_last pad_len b).+acc).*r,r,k)) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
      st
    else
      st) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
  st.

Definition poly1305_update (m : t_Seq_t t_U8_t) (st : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t)) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) :=
  let st := (poly1305_update_blocks m st) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
  let last := (get_remainder_chunk_under_impl_41 m v_BLOCKSIZE) : t_Seq_t t_U8_t in
  poly1305_update_last (len_under_impl_41 last) last st.

Definition poly1305_finish (st : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t)) : t_Poly1305Tag_t :=
  let '(acc,_,k) := (st) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
  let n := (v_U128_from_le_bytes (from_slice_under_impl_111 k (@repr WORDSIZE32 16) (@repr WORDSIZE32 16))) : t_U128_t in
  let aby := (to_byte_seq_le_under_impl_105 acc) : t_Seq_t t_U8_t in
  let a := (v_U128_from_le_bytes (from_slice_under_impl_111 aby (@repr WORDSIZE32 0) (@repr WORDSIZE32 16))) : t_U128_t in
  from_seq_under_impl_88 (v_U128_to_le_bytes (a.+n)).

Definition poly1305 (m : t_Seq_t t_U8_t) (key : t_PolyKey_t) : t_Poly1305Tag_t :=
  let st := (poly1305_init key) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
  let st := (poly1305_update m st) : (t_FieldElement_t × t_FieldElement_t × t_PolyKey_t) in
  poly1305_finish st.
